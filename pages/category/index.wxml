<nav nav-type="search" />
<view class="home-container">
  <view class="home-content">
    <!-- 添加加载状态 -->
    <view wx:if="{{loading}}" class="loading-container">
      <t-loading size="48rpx" text="加载中..." />
    </view>
    
    <t-tabs wx:else value="{{currentPrimary}}" bind:change="onTabChange">
      <block wx:for="{{primaryCategories}}" wx:key="id">
        <t-tab-panel label="{{item.name}}" value="{{item.id}}">
          <!-- 使用 scroll-view 替代 t-pull-down-refresh，以支持滚动监听 -->
          <scroll-view 
            scroll-y 
            style="height: 100%;"
            bindscrolltolower="onScrollToLower"
            bindscroll="onPageScroll"
            scroll-top="{{scrollTop}}"
            refresher-enabled
            refresher-triggered="{{enable}}"
            bindrefresherrefresh="onRefresh"
          >
            <view class="tab-content">
              <!-- 主体内容区域 -->
              <view class="main-content">
                <!-- 侧边二级导航 -->
                <view wx:if="{{showSecondarySidebar}}" class="sidebar {{isSidebarCollapsed ? 'collapsed' : ''}}">
                  <view class="sidebar-header">
                    <t-icon 
                      name="{{isSidebarCollapsed ? 'chevron-right' : 'chevron-left'}}" 
                      bindtap="toggleSidebar"
                      class="collapse-icon"
                    ></t-icon>
                    <text class="sidebar-title" wx:if="{{!isSidebarCollapsed}}">分类</text>
                  </view>
                  
                  <view class="sidebar-content" wx:if="{{!isSidebarCollapsed}}">
                    <block wx:for="{{secondaryCategories}}" wx:key="id">
                      <view 
                        class="secondary-item {{currentSecondary === item.id ? 'active' : ''}}"
                        bindtap="switchSecondaryCategory"
                        data-id="{{item.id}}"
                      >
                        <t-icon name="{{item.icon}}" class="item-icon"></t-icon>
                        <text class="item-name">{{item.name}}</text>
                        <text class="item-count">{{item.count}}</text>
                      </view>
                    </block>
                    
                    <!-- 二级分类为空时的提示 -->
                    <view wx:if="{{secondaryCategories.length === 0}}" class="empty-categories">
                      <text class="empty-text">暂无分类数据</text>
                    </view>
                  </view>
                </view>

                <!-- 内容展示区域 -->
                <view class="content-area {{!showSecondarySidebar || isSidebarCollapsed ? 'full-width' : ''}}">
                  <!-- 问题列表区域 -->
                  <view wx:if="{{currentQuestions.length > 0}}" class="questions-list">
                    <block wx:for="{{currentQuestions}}" wx:key="id">
                      <view class="question-item">
                        <t-cell 
                          title="{{item.name}}" 
                          description="{{item.description}}" 
                          hover
                          arrow
                          bindtap="onQuestionClick"
                          data-id="{{item.id}}"
                        >
                          <t-icon 
                            slot="left-icon" 
                            name="file" 
                            size="32rpx" 
                            color="var(--td-brand-color)"
                            class="avatar"
                          ></t-icon>
                          
                          <view slot="right-icon" class="question-meta">
                            <text class="question-difficulty {{item.difficulty}}">
                              {{item.difficulty === 'easy' ? '简单' : item.difficulty === 'medium' ? '中等' : '困难'}}
                            </text>
                          </view>
                        </t-cell>
                      </view>
                    </block>
                    
                    <!-- 加载更多提示 -->
                    <view wx:if="{{isLoadingMore}}" class="loading-more">
                      <t-loading size="32rpx" text="正在加载更多..." />
                    </view>
                    
                    <view wx:if="{{!hasMore && currentQuestions.length > 0}}" class="no-more">
                      <text>没有更多数据了</text>
                    </view>
                  </view>
                  
                  <!-- 问题为空时的提示 -->
                  <view wx:else class="empty-content">
                    <t-icon name="image" size="120rpx" color="#ccc"></t-icon>
                    <text class="empty-text">暂无内容</text>
                  </view>
                </view>
              </view>
            </view>
          </scroll-view>
        </t-tab-panel>
      </block>
    </t-tabs>
  </view>
</view>

<view class="home-release">
  <t-button theme="primary" size="large" icon="add" shape="round" bindtap="goRelease">
    发布
  </t-button>
</view>
<t-message id="t-message" />