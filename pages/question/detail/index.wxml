<!-- pages/question/detail/index.wxml -->
<view class="question-detail-container">
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-state">
    <view class="loading-content">
      <t-loading size="60rpx" text="加载中..."></t-loading>
    </view>
  </view>

  <!-- 错误状态 -->
  <view wx:elif="{{error}}" class="error-state">
    <view class="error-content">
      <t-icon name="error-circle" size="120rpx" color="#ff4d4f"></t-icon>
      <text class="error-text">{{errorMessage || '加载失败'}}</text>
      <t-button theme="primary" bindtap="retryLoad" class="retry-btn">
        重新加载
      </t-button>
    </view>
  </view>

  <!-- 空数据状态 -->
  <view wx:elif="{{isEmpty}}" class="empty-state">
    <view class="empty-content">
      <t-icon name="file" size="120rpx" color="#ccc"></t-icon>
      <text class="empty-text">题目不存在</text>
      <text class="empty-desc">该题目可能已被删除或不存在</text>
      <t-button theme="outline" bindtap="goBack" class="empty-btn">
        返回上一页
      </t-button>
    </view>
  </view>

  <!-- 正常内容 -->
  <view wx:else>
    <!-- 内容区域 -->
    <scroll-view class="content-scroll" scroll-y="true">
      <!-- 题目卡片 -->
      <view class="question-card">
        <!-- 标题区域 -->
        <view class="question-header">
          <view class="question-title-section">
            <text class="question-title">{{questionDetail.title}}</text>
          </view>
        </view>

        <!-- 标签区域 -->
        <view wx:if="{{questionDetail.tags && questionDetail.tags.length > 0}}" class="tags-section">
          <view class="section-title">知识点标签</view>
          <view class="tags-list">
            <t-tag wx:for="{{questionDetail.tags}}" wx:key="*this" theme="outline" size="small">
              {{item}}
            </t-tag>
          </view>
        </view>

        <!-- 题目内容区域 -->
        <view wx:if="{{questionDetail.content}}" class="content-section">
          <view class="question-content">
            <text class="content-text indent-paragraph">{{questionDetail.content}}</text>
          </view>
        </view>
      </view>

      <!-- 评论区 -->
      <view class="comment-section">
        <view class="section-header">
          <text class="section-title">评论 ({{questionDetail.commentCount || 0}})</text>
        </view>
        <view class="comment-input-area">
          <t-textarea value="{{commentText}}" placeholder="写下你的评论..." maxlength="200" bind:change="onCommentChange"></t-textarea>
          <view class="submit-btn-wrapper">
            <t-button theme="primary" size="small" bindtap="onSubmitComment" class="submit-btn">
              发布评论
            </t-button>
          </view>
        </view>
        <view class="comment-list">
          <block wx:for="{{comments}}" wx:key="id">
            <view class="comment-item">
              <view class="comment-header">
                <image class="comment-avatar" src="{{item.avatar || '/images/default-avatar.png'}}"></image>
                <view class="comment-user">
                  <text class="user-name">{{item.userName || '匿名用户'}}</text>
                  <text class="comment-time">{{item.createTime}}</text>
                </view>
              </view>
              <view class="comment-content">{{item.content}}</view>
              <view class="comment-actions">
                <view class="action-item" bindtap="onLikeComment" data-id="{{item.id}}">
                  <t-icon name="thumb-up" size="24rpx"></t-icon>
                  <text>{{item.likeCount || 0}}</text>
                </view>
                <view class="action-item" bindtap="onReplyComment" data-id="{{item.id}}">
                  <t-icon name="chat" size="24rpx"></t-icon>
                  <text>回复</text>
                </view>
              </view>
            </view>
          </block>
        </view>
      </view>

      <!-- 底部占位区域，防止内容被底部操作栏遮挡 -->
      <view class="bottom-placeholder"></view>
    </scroll-view>

    <!-- 底部浮动操作栏 -->
    <view class="floating-bottom-bar">
      <view class="floating-actions">
        <view class="action-item">
          <t-icon name="chat" size="32rpx"></t-icon>
          <text class="action-count">{{questionDetail.commentCount || 0}}</text>
        </view>
        <!-- 修改点赞按钮 -->
        <view class="action-item {{questionDetail.liked ? 'like-active' : ''}}" bindtap="onLike">
          <t-icon name="{{questionDetail.liked ? 'heart-filled' : 'heart'}}" size="32rpx" color="{{questionDetail.liked ? '#ff6b6b' : '#666'}}"></t-icon>
          <text class="action-count">{{questionDetail.likeCount || 0}}</text>
        </view>

        <!-- 修改收藏按钮 -->
        <view class="action-item {{questionDetail.collected ? 'collect-active' : ''}}" bindtap="onCollect">
          <t-icon name="{{questionDetail.collected ? 'star-filled' : 'star'}}" size="32rpx" color="{{questionDetail.collected ? '#ffd93d' : '#666'}}"></t-icon>
          <text class="action-count">{{questionDetail.collectCount || 0}}</text>
        </view>

        <view class="action-divider"></view>

        <view class="share-action" bindtap="onShare">
          <t-icon name="share" size="32rpx"></t-icon>
          <text>分享</text>
        </view>
      </view>
    </view>
  </view>
</view>
<!-- 分享 ActionSheet -->
<t-action-sheet id="t-action-sheet" visible="{{showShareActionSheet}}" bind:close="onShareActionSheetClose" bind:cancel="onShareActionSheetClose" bind:selected="onShareOptionSelect" theme="grid" align="center" items="{{shareOptions}}" cancel-text="取消分享" class="share-action-sheet" />
<!-- index.wxml -->


<!-- 分享引导 -->
<t-popup visible="{{showCustomGuide}}" bind:visible-change="onCloseCustomGuide" placement="center" overlay-props="{{ { background: 'rgba(0, 0, 0, 0.6)' } }}">
  <view class="custom-guide-popup">
    <view class="guide-header">
      <t-icon name="share" size="48rpx" color="#07c160"></t-icon>
      <text class="guide-title">分享指引</text>
    </view>
    <view class="guide-content">
      <text class="guide-text">请点击右上角"···"按钮</text>
      <text class="guide-text">然后选择"转发"将题目分享给好友</text>
    </view>
    <view class="guide-actions">
      <t-button theme="primary" bindtap="onCloseCustomGuide" size="large">知道了</t-button>
    </view>
  </view>
</t-popup>

<t-message id="t-message" />